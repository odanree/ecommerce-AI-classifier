name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check PR title format
      run: |
        TITLE="${{ github.event.pull_request.title }}"
        if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:\ .+ ]]; then
          echo "❌ PR title does not follow conventional commit format"
          echo "Expected format: <type>(<scope>): <description>"
          echo "Example: feat(training): add learning rate scheduler"
          exit 1
        fi
        echo "✅ PR title follows conventional commit format"

    - name: Run tests
      run: |
        pytest tests/ -v --tb=short

    - name: Check test coverage
      run: |
        pytest tests/ --cov=src --cov-report=term-missing --cov-fail-under=20

    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const status = context.job.status;
          const emoji = status === 'success' ? '✅' : '❌';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${emoji} All checks passed!\n\n- Tests: All passing\n- Code style: Checked\n- Coverage: Maintained`
          });
